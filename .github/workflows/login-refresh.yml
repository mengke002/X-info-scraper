name: Refresh Twitter Session

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * 0' # æ¯å‘¨æ—¥è¿è¡Œä¸€æ¬¡ï¼Œåˆ·æ–° Session (æˆ–è€…æŒ‰éœ€è°ƒæ•´)

jobs:
  login-and-update-profile:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      HEADLESS: true # ç™»å½•æ—¶å¿…é¡»ä½¿ç”¨æ— å¤´æ¨¡å¼ (é…åˆ puppeteer-extra-plugin-stealth)
      TWITTER_USERNAME: ${{ secrets.TWITTER_USERNAME }}
      TWITTER_PASSWORD: ${{ secrets.TWITTER_PASSWORD }}
      TWITTER_HANDLE: ${{ secrets.TWITTER_HANDLE }} # æ–°å¢: ç”¨æˆ·å Handle
      TWITTER_COOKIES_JSON: ${{ secrets.TWITTER_COOKIES_JSON }} # æ–°å¢: Twitter Cookies JSON
      DB_ENABLED: 'false' # æ­¤å·¥ä½œæµä¸éœ€è¦æ•°æ®åº“
      # å¦‚æœæœ‰æ‰‹æœºå·éªŒè¯éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥é…ç½® TWITTER_PHONE
      # TWITTER_PHONE: ${{ secrets.TWITTER_PHONE }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 1. è®¾ç½® SSH Key ä»¥ä¾¿æ‹‰å–å’Œæ¨é€ Profile ä»“åº“
      - name: Setup SSH for Profile Repo
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROFILE_REPO_SSH_KEY }}

      # 2. æ‹‰å–å½“å‰çš„ Profile ä»“åº“ (ä¸ºäº†ä¿æŒ git å†å²)
      - name: Clone Profile Repo
        run: |
          mkdir -p data
          # ä½¿ç”¨ SSH URL å…‹éš†
          git clone git@github.com:mengke002/X-info-scraper-profile.git data/chrome-profile-repo
          
          # å‡†å¤‡å·¥ä½œç›®å½•: 
          # å¦‚æœ repo é‡Œå·²æœ‰ profileï¼Œå…ˆå¤åˆ¶è¿‡æ¥ï¼Œä»¥ä¾¿ Puppeteer åœ¨æ­¤åŸºç¡€ä¸Šæ›´æ–° (è€Œä¸æ˜¯å®Œå…¨æ–°å»º)
          # ä½†å¦‚æœæ˜¯ä¸ºäº†è§£å†³è§£å¯†å¤±è´¥é—®é¢˜ï¼Œä¹Ÿè®¸"ä»é›¶å¼€å§‹"æ›´å¥½ï¼Ÿ
          # ç­–ç•¥ï¼šå…ˆå°è¯•ä»é›¶å¼€å§‹ç™»å½•ï¼Œç”Ÿæˆå…¨æ–°çš„å¹²å‡€ Profile
          mkdir -p data/chrome-profile

      # 3. æ‰§è¡Œç™»å½•è„šæœ¬ (Batch Mode ä½†ä»…ä¸ºäº†ç™»å½•)
      # æˆ‘ä»¬è¿è¡Œä¸€ä¸ªéå¸¸ç®€å•çš„ä»»åŠ¡ (æ¯”å¦‚é‡‡é›†å•æ¡æ•°æ®)ï¼Œä»¥æ­¤è§¦å‘ login æµç¨‹
      - name: Perform Login
        run: |
          echo "ğŸ” Starting login process..."
          # è¿è¡Œ batch è„šæœ¬ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å®Œæ•´çš„åˆå§‹åŒ–å’Œç™»å½•é€»è¾‘
          # ä½¿ç”¨ --single æ¨¡å¼é‡‡é›†ä¸€ä¸ªç®€å•çš„ç”¨æˆ·ï¼Œåªä¸ºè§¦å‘ç™»å½•
          # --count=1 é™åˆ¶æ•°é‡ï¼Œå°½å¿«ç»“æŸ
          npm run batch -- --single=Twitter --type=posts --count=1
        continue-on-error: false # å¦‚æœç™»å½•å¤±è´¥ï¼Œæ•´ä¸ªä»»åŠ¡å¤±è´¥

      # 4. éªŒè¯ Profile æ˜¯å¦ç”Ÿæˆ
      - name: Verify Profile
        run: |
          if [ -d "data/chrome-profile/Default" ]; then
            echo "âœ… New profile generated"
            ls -lh data/chrome-profile/Default/Cookies
          else
            echo "âŒ Profile generation failed"
            exit 1
          fi

      # 5. æ›´æ–° Profile ä»“åº“
      - name: Push New Profile
        run: |
          cd data/chrome-profile-repo
          
          # æ¸…ç©ºæ—§çš„ profile å†…å®¹ (é™¤äº† .git)
          # find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +
          # æˆ–è€…æ›´å®‰å…¨çš„æ–¹å¼ï¼šç›´æ¥ç”¨ rsync åŒæ­¥
          
          # ä½¿ç”¨ rsync å°†æ–°ç”Ÿæˆçš„ profile åŒæ­¥åˆ° repo ç›®å½•
          # --delete ç¡®ä¿åˆ é™¤ repo ä¸­æœ‰ä½†æ–° profile ä¸­æ²¡æœ‰çš„æ—§åƒåœ¾æ–‡ä»¶
          rsync -av --delete --exclude='.git' ../chrome-profile/ ./chrome-profile/
          
          # æäº¤æ›´æ”¹
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to profile"
          else
            echo "ğŸ“¦ Committing new profile..."
            git commit -m "ğŸ”„ Auto-refresh Chrome Profile [skip ci]"
            git push
            echo "âœ… Profile updated successfully"
          fi
