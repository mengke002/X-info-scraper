name: Twitter Data Scraper

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: 'batch'
        type: choice
        options:
          - batch
          - single
      batch_size:
        description: 'Batch size (random N users from database)'
        required: false
        default: '20'
      frequency_group:
        description: 'User frequency group to scrape'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - high     # é«˜é¢‘ç”¨æˆ· (æ¯6å°æ—¶)
          - medium   # ä¸­é¢‘ç”¨æˆ· (æ¯å¤©)
          - low      # ä½é¢‘ç”¨æˆ· (æ¯å‘¨)

  # è‡ªåŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆåŒ—äº¬æ—¶é—´ 8-24ç‚¹ï¼‰
  schedule:
    # é«˜é¢‘ç”¨æˆ·ï¼šæ¯2å°æ—¶ (åŒ—äº¬æ—¶é—´ 8, 10, 12, 14, 16, 18, 20, 22ç‚¹)
    # UTC æ—¶é—´: 0, 2, 4, 6, 8, 10, 12, 14
    - cron: '0 0,2,4,6,8,10,12,14 * * *'

    # ä¸­é¢‘ç”¨æˆ·ï¼šæ¯4å°æ—¶ (åŒ—äº¬æ—¶é—´ 8, 12, 16, 20ç‚¹)
    # UTC æ—¶é—´: 0, 4, 8, 12
    - cron: '30 0,4,8,12 * * *'

    # ä½é¢‘ç”¨æˆ·ï¼šæ¯6å°æ—¶ (åŒ—äº¬æ—¶é—´ 8, 14, 20ç‚¹)
    # UTC æ—¶é—´: 0, 6, 12
    - cron: '45 0,6,12 * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # æœ€é•¿è¿è¡Œ2å°æ—¶

    env:
      # æ•°æ®åº“è¿æ¥ï¼ˆä» Secrets è¯»å–ï¼‰
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # æ— å¤´æ¨¡å¼ï¼ˆGitHub Actions å¿…é¡»å¯ç”¨ï¼‰
      HEADLESS: true
      # Webhook URL (ç”¨äºå¤±è´¥é€šçŸ¥)
      WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ‹‰å– chrome-profileï¼ˆä» private repoï¼‰
      - name: Checkout profile repo
        uses: actions/checkout@v4
        with:
          repository: mengke002/X-info-scraper-profile
          ssh-key: ${{ secrets.PROFILE_REPO_SSH_KEY }}
          path: data/chrome-profile-repo

      - name: Setup chrome profile
        run: |
          # ä» profile repo å¤åˆ¶ chrome-profile åˆ°æ­£ç¡®ä½ç½®
          cp -r data/chrome-profile-repo/chrome-profile data/chrome-profile

          # æ£€æŸ¥ profile çŠ¶æ€
          if [ -d "data/chrome-profile/Default" ]; then
            echo "âœ… Chrome profile loaded from private repo"
            ls -lh data/chrome-profile/Default/Cookies || echo "âš ï¸ No Cookies file"
            du -sh data/chrome-profile
          else
            echo "âŒ Chrome profile not found!"
            exit 1
          fi

      # å®‰è£… Chrome æµè§ˆå™¨ï¼ˆGitHub Actions ç¯å¢ƒï¼‰
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable

      - name: Verify Chrome installation
        run: |
          which google-chrome-stable || which google-chrome || which chromium
          google-chrome-stable --version || google-chrome --version || chromium --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install XVFB
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Install dependencies
        run: npm ci

      # è¿è¡Œé‡‡é›†ä»»åŠ¡
      - name: Run scraper (Batch Mode)
        if: github.event.inputs.mode == 'batch' || github.event_name == 'schedule'
        env:
          USE_XVFB: true # å¯ç”¨ XVFB è™šæ‹Ÿæ˜¾ç¤ºå™¨
        run: |
          # æ ¹æ®å®šæ—¶ä»»åŠ¡æ—¶é—´ç¡®å®šé¢‘ç‡ç»„
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # è·å–å½“å‰ UTC æ—¶é—´çš„åˆ†é’Ÿæ•°æ¥åˆ¤æ–­æ˜¯å“ªä¸ª cron è§¦å‘çš„
            MINUTE=$(date -u +%M)

            echo "Current UTC minute: $MINUTE"

            # 0åˆ† -> high, 30åˆ† -> medium, 45åˆ† -> low
            if [ "$MINUTE" -eq "0" ]; then
              FREQ="high"
            elif [ "$MINUTE" -eq "30" ]; then
              FREQ="medium"
            elif [ "$MINUTE" -eq "45" ]; then
              FREQ="low"
            else
              FREQ="all"
            fi
          else
            FREQ="${{ github.event.inputs.frequency_group || 'all' }}"
          fi

          BATCH_SIZE="${{ github.event.inputs.batch_size || '20' }}"

          echo "ğŸ“Š Running batch scraper:"
          echo "  - Frequency group: $FREQ"
          echo "  - Batch size: $BATCH_SIZE"

          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" npm run batch -- --batch-size=$BATCH_SIZE --frequency=$FREQ

      # æ¸…ç†å’Œæ£€æŸ¥
      - name: Cleanup and check output
        if: always()
        run: |
          # æ¸…ç† node_modulesï¼ˆä¸éœ€è¦æäº¤ï¼‰
          rm -rf node_modules

          # æ£€æŸ¥ profile å¤§å°
          echo "ğŸ“¦ Chrome profile size:"
          du -sh data/chrome-profile || echo "Profile not found"

          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
          echo "ğŸ“„ Output files:"
          ls -lh output/ || echo "No output files"

          # æ£€æŸ¥æ‰¹é‡æŠ¥å‘Š
          if [ -f "output/batch-report.json" ]; then
            echo "ğŸ“Š Batch report preview:"
            head -n 30 output/batch-report.json
          fi

      # æäº¤æ›´æ–°çš„æ•°æ®ï¼ˆå¯é€‰ï¼‰
      - name: Commit updates
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # åªæäº¤è¾“å‡ºæ–‡ä»¶å’ŒæŠ¥å‘Šï¼Œä¸æäº¤ profileï¼ˆå¤ªå¤§ä¸”ä¼šè¢« cacheï¼‰
          git add output/ || true
          git add logs/ || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-update: Scraper run #${{ github.run_number }} [skip ci]"
            git push
          fi

      # ä¸Šä¼ è¾“å‡ºæ–‡ä»¶ï¼ˆ30å¤©ä¿ç•™ï¼‰
      - name: Upload output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-output-${{ github.run_number }}
          path: |
            output/
            logs/
          retention-days: 30

      # å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® WEBHOOK_URLï¼‰
      - name: Notify on failure
        if: failure() && env.WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ env.WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"âŒ Twitter scraper failed! Run #${{ github.run_number }}\"}" || true
